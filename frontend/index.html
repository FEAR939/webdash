<!doctype html>
<html lang="en" class="h-full w-full">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Webdash</title>
    </head>
    <body class="h-fit w-full bg-neutral-900 p-4 flex flex-wrap">
        <div id="hostname" class="text-white w-full"></div>
        <div class="md:w-1/2 w-full h-64">
            <canvas id="CPUchart"></canvas>
        </div>

        <div class="md:w-1/2 w-full h-64">
            <canvas id="RAMchart"></canvas>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
        <script>
            const hostnamefield = document.getElementById("hostname");
            const CPUctx = document.getElementById("CPUchart").getContext("2d");
            const RAMctx = document.getElementById("RAMchart").getContext("2d");

            async function getTotalMem() {
                const response = await fetch("/gettotalmem");
                const data = await response.json();
                return data.total;
            }

            // Define a light color for contrast
            const chartLineColor = "rgba(54, 162, 235, 1)"; // A nice blue
            const chartFillColor = "rgba(54, 162, 235, 0.2)"; // Semi-transparent blue for fill

            const CPUchart = new Chart(CPUctx, {
                type: "line",
                data: {
                    // You might want labels for the X-axis eventually
                    // labels: [],
                    datasets: [
                        {
                            label: "CPU",
                            fill: true, // Fill the area under the line
                            data: [],
                            borderWidth: 1,
                            borderColor: chartLineColor, // <-- Added: Set line color
                            backgroundColor: chartFillColor, // <-- Added: Set fill color (needed for fill: true)
                            tension: 0.1, // Optional: makes the line slightly curved
                            pointRadius: 0, // Hide data points
                            pointHoverRadius: 0, // Hide data points on hover
                        },
                    ],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            // Configure X-axis ticks/grid color if needed
                            ticks: { color: "rgba(255, 255, 255, 0.7)" },
                            grid: { color: "rgba(255, 255, 255, 0.1)" },
                        },
                        y: {
                            beginAtZero: true,
                            max: 100, // Set maximum value for Y-axis
                            // Configure Y-axis ticks/grid color
                            ticks: { color: "rgba(255, 255, 255, 0.7)" },
                            grid: { color: "rgba(255, 255, 255, 0.1)" },
                        },
                    },
                    plugins: {
                        // Configure legend color
                        legend: {
                            labels: {
                                color: "rgba(255, 255, 255, 0.9)", // Make legend text visible
                            },
                        },
                    },
                },
            });

            const RAMchart = new Chart(RAMctx, {
                type: "line",
                data: {
                    // You might want labels for the X-axis eventually
                    // labels: [],
                    datasets: [
                        {
                            label: "RAM",
                            fill: true,
                            data: [],
                            borderWidth: 1,
                            borderColor: chartLineColor, // <-- Added: Set line color
                            backgroundColor: chartFillColor,
                            tension: 0.1, // Optional: makes the line slightly curved
                            pointRadius: 0, // Hide data points
                            pointHoverRadius: 0, // Hide data points on hover
                        },
                    ],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    // Copy similar options for consistency
                    scales: {
                        x: {
                            // Configure X-axis ticks/grid color if needed
                            ticks: { color: "rgba(255, 255, 255, 0.7)" },
                            grid: { color: "rgba(255, 255, 255, 0.1)" },
                        },
                        y: {
                            beginAtZero: true,
                            // Configure Y-axis ticks/grid color
                            ticks: { color: "rgba(255, 255, 255, 0.7)" },
                            grid: { color: "rgba(255, 255, 255, 0.1)" },
                        },
                    },
                    plugins: {
                        // Configure legend color
                        legend: {
                            labels: {
                                color: "rgba(255, 255, 255, 0.9)", // Make legend text visible
                            },
                        },
                    },
                },
            });

            // --- Your existing loop function remains the same ---
            async function loop() {
                try {
                    // Add error handling for the fetch request
                    const response = await fetch("/getutil");
                    if (!response.ok) {
                        console.error(
                            "Failed to fetch /getutil:",
                            response.status,
                            response.statusText,
                        );
                        // Optional: Display error to user or stop loop
                        setTimeout(loop, 5000); // Retry after longer delay
                        return;
                    }
                    const util = await response.json();

                    if (util.cpu == 0 || util.mem == 0)
                        return setTimeout(loop, 1000);

                    // Add timestamp labels (optional but good practice)
                    const now = new Date();
                    const label = `${now.getHours()}:${now.getMinutes()}:${now.getSeconds()}`;

                    // Add labels and data
                    CPUchart.data.labels.push(label);
                    CPUchart.data.datasets[0].data.push(util.cpu);
                    RAMchart.data.labels.push(label); // Keep labels in sync
                    RAMchart.data.datasets[0].data.push(util.mem);

                    // Optional: Limit the number of data points shown
                    const maxDataPoints = 60; // Show last 60 seconds
                    if (CPUchart.data.labels.length > maxDataPoints) {
                        CPUchart.data.labels.shift(); // Remove oldest label
                        CPUchart.data.datasets[0].data.shift(); // Remove oldest data point
                        RAMchart.data.labels.shift();
                        RAMchart.data.datasets[0].data.shift();
                    }

                    CPUchart.update();
                    RAMchart.update();

                    setTimeout(loop, 1000); // Continue loop
                } catch (error) {
                    console.error("Error in loop:", error);
                    setTimeout(loop, 5000); // Retry after delay on error
                }
            }

            window.onload = async function () {
                // Initialize labels arrays if you add them
                CPUchart.data.labels = [];
                RAMchart.data.labels = [];

                const hostname = await (await fetch("/gethostname")).text();
                hostnamefield.textContent = hostname;

                RAMchart.options.scales.y.max = await getTotalMem();
                loop();
            };
        </script>
    </body>
</html>
